---
export const prerender = false;
import PublicLayout from '../../layouts/PublicLayout.astro';
import { getDictionary } from '../../lib/i18n.js';

const db = Astro.locals.runtime?.env?.DB;
const { lang } = Astro.params;
const url = new URL(Astro.request.url);

// Read all filter params from URL
const searchQuery  = url.searchParams.get('q') || '';
const priceMin     = url.searchParams.get('price_min') || '';
const priceMax     = url.searchParams.get('price_max') || '';
const bedroomsMin  = url.searchParams.get('beds') || '';
const propType     = url.searchParams.get('type') || '';
const category     = url.searchParams.get('category') || '';
const areaFilter   = url.searchParams.get('area') || '';
const countryFilter = url.searchParams.get('country') || '';

const dict = await getDictionary(db, lang) || {};
const fallbackDict = await getDictionary(db, 'en') || {};
const t = (key) => dict[key] || fallbackDict[key] || key;

// Fetch countries & areas for filter dropdowns
const { results: countries } = await db.prepare(`
    SELECT c.id, li.name FROM countries c
    JOIN location_i18n li ON c.id = li.entity_id AND li.lang = ? AND li.entity_type = 'country'
    ORDER BY li.name
`).bind(lang).all();

const { results: areas } = await db.prepare(`
    SELECT a.id, a.city_id, li.name, 
           (SELECT li2.name FROM location_i18n li2 WHERE li2.entity_id = ci.country_id AND li2.lang = ? AND li2.entity_type = 'country') as country_name
    FROM areas a
    JOIN cities ci ON a.city_id = ci.id
    JOIN location_i18n li ON a.id = li.entity_id AND li.lang = ? AND li.entity_type = 'area'
    ORDER BY country_name, li.name
`).bind(lang, lang).all();

// Build dynamic query
let query = `
    SELECT 
        l.id, l.price, l.bedrooms, l.area_sqm, l.type, l.main_category,
        COALESCE(i_lang.title, i_en.title) as title, 
        COALESCE(i_lang.slug, i_en.slug) as property_slug,
        (SELECT r2_key FROM media WHERE listing_id = l.id ORDER BY is_primary DESC, sort_order ASC LIMIT 1) as main_image,
        (SELECT name FROM location_i18n WHERE entity_id = l.area_id AND lang = ? AND entity_type = 'area') as area_name,
        (SELECT slug FROM location_i18n WHERE entity_id = l.area_id AND lang = ? AND entity_type = 'area') as area_slug,
        (SELECT slug FROM location_i18n WHERE entity_id = (SELECT city_id FROM areas WHERE id = l.area_id) AND lang = ? AND entity_type = 'city') as city_slug,
        (SELECT slug FROM location_i18n WHERE entity_id = (SELECT country_id FROM cities WHERE id = (SELECT city_id FROM areas WHERE id = l.area_id)) AND lang = ? AND entity_type = 'country') as country_slug
    FROM listings l
    LEFT JOIN listing_i18n i_lang ON l.id = i_lang.listing_id AND i_lang.lang = ?
    LEFT JOIN listing_i18n i_en ON l.id = i_en.listing_id AND i_en.lang = 'en'
    WHERE l.status = 'published'
`;

const params = [lang, lang, lang, lang, lang];

if (searchQuery)  { query += ` AND (COALESCE(i_lang.title, i_en.title) LIKE ? OR COALESCE(i_lang.description, i_en.description) LIKE ?)`; params.push(`%${searchQuery}%`, `%${searchQuery}%`); }
if (priceMin)     { query += ` AND l.price >= ?`; params.push(Number(priceMin)); }
if (priceMax)     { query += ` AND l.price <= ?`; params.push(Number(priceMax)); }
if (bedroomsMin)  { query += ` AND l.bedrooms >= ?`; params.push(Number(bedroomsMin)); }
if (propType)     { query += ` AND l.type = ?`; params.push(propType); }
if (category)     { query += ` AND l.main_category = ?`; params.push(category); }
if (areaFilter)   { query += ` AND l.area_id = ?`; params.push(areaFilter); }
if (countryFilter) {
    query += ` AND l.area_id IN (
        SELECT a.id FROM areas a 
        JOIN cities ci ON a.city_id = ci.id 
        WHERE ci.country_id = ?
    )`;
    params.push(countryFilter);
}

query += ` ORDER BY l.created_at DESC`;

const { results: properties } = await db.prepare(query).bind(...params).all();

const hasFilters = searchQuery || priceMin || priceMax || bedroomsMin || propType || category || areaFilter || countryFilter;
---

<PublicLayout title={`${t('nav.properties')} - ${t('title')}`} lang={lang} activePage="properties">
  <style>
    /* LAYOUT */
    .page-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 0;
      max-width: 1400px;
      margin: 0 auto;
      min-height: calc(100vh - 57px);
    }
    /* SIDEBAR */
    .filter-sidebar {
      background: #fff;
      border-right: 1px solid #e4e4e7;
      padding: 2rem 1.5rem;
      position: sticky;
      top: 57px;
      height: calc(100vh - 57px);
      overflow-y: auto;
    }
    .sidebar-title {
      font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; color: #a1a1aa; margin: 0 0 1.5rem;
    }
    .filter-group { margin-bottom: 2rem; }
    .filter-label {
      display: block; font-size: 0.8rem; font-weight: 600;
      color: #3f3f46; margin-bottom: 0.6rem;
    }
    .filter-input, .filter-select {
      width: 100%; padding: 0.6rem 0.9rem;
      border: 1.5px solid #e4e4e7; border-radius: 10px;
      font-size: 0.9rem; font-family: inherit; color: #18181b;
      background: #fafafa; outline: none; transition: border-color 0.15s;
    }
    .filter-input:focus, .filter-select:focus { border-color: #18181b; background: #fff; }
    .price-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .price-row .filter-input { padding: 0.6rem 0.6rem; }
    .bed-buttons { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .bed-btn {
      padding: 0.4rem 0.8rem; border: 1.5px solid #e4e4e7; border-radius: 8px;
      font-size: 0.8rem; font-weight: 600; cursor: pointer;
      background: #fafafa; color: #71717a; transition: all 0.15s;
    }
    .bed-btn:hover { border-color: #18181b; color: #18181b; }
    .bed-btn.active { background: #18181b; color: #fff; border-color: #18181b; }
    .cat-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }
    .cat-btn {
      padding: 0.5rem 0.5rem; border: 1.5px solid #e4e4e7; border-radius: 8px;
      font-size: 0.8rem; font-weight: 600; cursor: pointer; text-align: center;
      background: #fafafa; color: #71717a; transition: all 0.15s;
    }
    .cat-btn:hover { border-color: #18181b; color: #18181b; }
    .cat-btn.active { background: #18181b; color: #fff; border-color: #18181b; }
    .clear-link {
      display: block; text-align: center; margin-top: 0.75rem;
      font-size: 0.8rem; color: #71717a; text-decoration: underline; cursor: pointer;
    }
    .clear-link:hover { color: #dc2626; }
    /* RESULTS */
    .results-area { padding: 2rem; background: #f4f4f5; }
    .results-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1.5rem;
    }
    .results-count { font-size: 0.9rem; color: #71717a; font-weight: 500; }
    .results-count strong { color: #18181b; }
    .property-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    .property-card {
      background: #fff; border-radius: 16px; overflow: hidden;
      border: 1px solid #e4e4e7; transition: transform 0.25s, box-shadow 0.25s;
      display: flex; flex-direction: column;
    }
    .property-card:hover { transform: translateY(-4px); box-shadow: 0 16px 30px -8px rgba(0,0,0,0.12); }
    .property-image { position: relative; aspect-ratio: 16/10; background: #f4f4f5; }
    .property-image img { width: 100%; height: 100%; object-fit: cover; }
    .property-price {
      position: absolute; bottom: 0.75rem; left: 0.75rem;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
      padding: 0.35rem 0.85rem; border-radius: 8px;
      font-weight: 800; font-size: 1.1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .property-badge {
      position: absolute; top: 0.75rem; right: 0.75rem;
      padding: 0.2rem 0.65rem; border-radius: 6px; font-size: 0.7rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
      background: #18181b; color: #fff;
    }
    .property-content { padding: 1.25rem 1.25rem 1.5rem; flex: 1; display: flex; flex-direction: column; }
    .property-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 0.35rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .property-area { color: #71717a; font-size: 0.825rem; margin-bottom: 1rem; }
    .property-info { display: flex; gap: 1.25rem; padding-top: 1rem; border-top: 1px solid #f4f4f5; margin-top: auto; }
    .info-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.825rem; color: #52525b; font-weight: 500; }
    .empty-state { text-align: center; padding: 5rem 2rem; color: #a1a1aa; }
    .empty-state h3 { font-size: 1.5rem; font-weight: 700; color: #3f3f46; margin-bottom: 0.5rem; }
    @media (max-width: 900px) {
      .page-layout { grid-template-columns: 1fr; }
      .filter-sidebar { position: static; height: auto; border-right: none; border-bottom: 1px solid #e4e4e7; }
    }
  </style>

  <div class="page-layout">
    <!-- FILTER SIDEBAR -->
    <aside class="filter-sidebar">
      <p class="sidebar-title">üîç Search &amp; Filter</p>
      <form id="filterForm" action={`/${lang}/properties`} method="get">
        <div class="filter-group">
          <label class="filter-label">Keyword</label>
          <input type="text" name="q" class="filter-input" placeholder="Title, description..." value={searchQuery} />
        </div>
        <div class="filter-group">
          <label class="filter-label">Price Range (‚Ç¨)</label>
          <div class="price-row">
            <input type="number" name="price_min" class="filter-input" placeholder="Min" value={priceMin} min="0" step="1000" />
            <input type="number" name="price_max" class="filter-input" placeholder="Max" value={priceMax} min="0" step="1000" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Bedrooms</label>
          <div class="bed-buttons">
            {['', '1', '2', '3', '4'].map(n => (
              <button type="button" class={`bed-btn${bedroomsMin === n ? ' active' : ''}`} data-beds={n}
                onclick={`document.getElementById('bedsInput').value='${n}'; document.querySelectorAll('.bed-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active');`}>
                {n === '' ? 'Any' : `${n}+`}
              </button>
            ))}
          </div>
          <input type="hidden" name="beds" id="bedsInput" value={bedroomsMin} />
        </div>
        <div class="filter-group">
          <label class="filter-label">Category</label>
          <div class="cat-buttons">
            {[['', 'Any'], ['for_sale', 'üè∑Ô∏è For Sale'], ['for_rent', 'üîë For Rent']].map(([val, label]) => (
              <button type="button" class={`cat-btn${category === val ? ' active' : ''}`}
                onclick={`document.getElementById('categoryInput').value='${val}'; document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active');`}>
                {label}
              </button>
            ))}
          </div>
          <input type="hidden" name="category" id="categoryInput" value={category} />
        </div>
        <div class="filter-group">
          <label class="filter-label">Property Type</label>
          <select name="type" class="filter-select">
            <option value="">Any Type</option>
            <option value="apartment"   selected={propType === 'apartment'}  >Apartment</option>
            <option value="house"       selected={propType === 'house'}      >House</option>
            <option value="penthouse"   selected={propType === 'penthouse'}  >Penthouse</option>
            <option value="lodge"       selected={propType === 'lodge'}      >Lodge</option>
            <option value="new_development" selected={propType === 'new_development'}>New Development</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Country</label>
          <select name="country" class="filter-select" id="countrySelect">
            <option value="">Any Country</option>
            {countries.map((c: any) => (
              <option value={c.id} selected={countryFilter === c.id}>{c.name}</option>
            ))}
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Area / Neighborhood</label>
          <select name="area" class="filter-select" id="areaSelect">
            <option value="">Any Area</option>
            {areas.map((a: any) => (
              <option value={a.id} selected={areaFilter === a.id}>{a.country_name} ‚Üí {a.name}</option>
            ))}
          </select>
        </div>
        <button type="submit" style="display:none" aria-hidden="true"></button>
        <p style="font-size:0.75rem;color:#a1a1aa;text-align:center;margin:0.5rem 0 0;">‚ö° Filters apply instantly</p>
        <a href={`/${lang}/properties`} class="clear-link">Clear all filters</a>
      </form>
    </aside>

    <!-- RESULTS -->
    <div class="results-area">
      <div class="results-header">
        <p class="results-count">
          <strong>{properties?.length || 0}</strong> {properties?.length === 1 ? 'property' : 'properties'} found
          {hasFilters ? ' (filtered)' : ''}
        </p>
      </div>

      {properties?.length > 0 ? (
        <div class="property-grid">
          {properties.map(p => {
            const countrySlug = p.country_slug || 'all';
            const citySlug = p.city_slug || 'all';
            const areaSlug = p.area_slug || 'all';
            const propertySlug = p.property_slug || p.id;
            const propertyUrl = `/${lang}/properties/${countrySlug}/${citySlug}/${areaSlug}/${propertySlug}`;

            return (
              <a href={propertyUrl} class="property-card">
                <div class="property-image">
                  {p.main_image ? (
                    <img src={`/api/media/${p.main_image}?w=600`} alt={p.title} loading="lazy" decoding="async" />
                  ) : (
                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#a1a1aa;font-size:0.85rem;">No image</div>
                  )}
                  <div class="property-price">
                    {new Intl.NumberFormat(lang === 'bg' ? 'bg-BG' : 'en-US', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(p.price)}
                  </div>
                  {p.type && <div class="property-badge">{p.type.replace('_', ' ')}</div>}
                </div>
                <div class="property-content">
                  <h3 class="property-title">{p.title || 'Property Listing'}</h3>
                  <div class="property-area">üìç {p.area_name || 'Premium Location'}</div>
                  <div class="property-info">
                    <div class="info-item"><span>üõèÔ∏è</span><span>{p.bedrooms || 0} {t('listing.bedrooms')}</span></div>
                    <div class="info-item"><span>üìê</span><span>{p.area_sqm || 0} m¬≤</span></div>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div class="empty-state">
          <h3>No properties found</h3>
          <p>{t('search.no_results')}</p>
          <a href={`/${lang}/properties`} style="color: #18181b; font-weight: 700; text-decoration: underline; margin-top: 1rem; display: inline-block;">
            {t('search.clear_filters')}
          </a>
        </div>
      )}
    </div>
  </div>

  <script is:inline>
    (function () {
      const form = document.getElementById('filterForm');
      if (!form) return;
      let debounceTimer;
      function debouncedSubmit() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => form.submit(), 500);
      }
      function immediateSubmit() {
        clearTimeout(debounceTimer);
        form.submit();
      }
      form.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.addEventListener('input', debouncedSubmit);
      });
      form.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', immediateSubmit);
      });
      form.querySelectorAll('.bed-btn, .cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setTimeout(immediateSubmit, 20);
        });
      });
    })();
  </script>
</PublicLayout>
