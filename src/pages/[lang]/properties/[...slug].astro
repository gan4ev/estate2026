---
export const prerender = false;
import PublicLayout from '../../../layouts/PublicLayout.astro';
import { getDictionary, getAvailableLanguages } from '../../../lib/i18n.js';

const db = Astro.locals.runtime?.env?.DB;
const { lang, slug } = Astro.params;

const langs = await getAvailableLanguages(db);
const dict = await getDictionary(db, lang) || {};
const fallbackDict = await getDictionary(db, 'en') || {};
const t = (key) => dict[key] || fallbackDict[key] || key;

// Parse hierarchical slug: country/city/area/property-title
const slugParts = slug?.split('/') || [];
const propertySlug = slugParts[slugParts.length - 1];

// Fetch property by slug ‚Äî try current lang first, fall back to English
const query = `
    SELECT 
        l.*, 
        COALESCE(i_lang.title, i_en.title) as title, 
        COALESCE(i_lang.description, i_en.description) as description,
        COALESCE(i_lang.meta_title, i_en.meta_title) as meta_title,
        COALESCE(i_lang.meta_description, i_en.meta_description) as meta_description,
        COALESCE(i_lang.slug, i_en.slug) as property_slug,
        (SELECT name FROM location_i18n WHERE entity_id = l.area_id AND lang = ? AND entity_type = 'area') as area_name,
        (SELECT slug FROM location_i18n WHERE entity_id = l.area_id AND lang = ? AND entity_type = 'area') as area_slug,
        (SELECT ci.id FROM areas a JOIN cities ci ON a.city_id = ci.id WHERE a.id = l.area_id) as city_id,
        (SELECT r2_key FROM media WHERE listing_id = l.id ORDER BY is_primary DESC, sort_order ASC LIMIT 1) as main_image
    FROM listings l
    LEFT JOIN listing_i18n i_lang ON l.id = i_lang.listing_id AND i_lang.lang = ?
    LEFT JOIN listing_i18n i_en ON l.id = i_en.listing_id AND i_en.lang = 'en'
    WHERE (i_lang.slug = ? OR i_en.slug = ?) AND l.status = 'published'
    LIMIT 1
`;

const { results } = await db.prepare(query).bind(lang, lang, lang, propertySlug, propertySlug).all();
const property = results?.[0];

if (!property) {
    return Astro.redirect(`/${lang}/404`);
}

// Build exact localized paths for the language switcher
const langPaths: Record<string, string> = {};
for (const l of langs) {
    const { results: pathRes } = await db.prepare(`
        SELECT 
            COALESCE((SELECT slug FROM location_i18n WHERE entity_id = (SELECT country_id FROM cities WHERE id = (SELECT city_id FROM areas WHERE id = ?)) AND lang = ? AND entity_type = 'country'), 'all') as country_slug,
            COALESCE((SELECT slug FROM location_i18n WHERE entity_id = (SELECT city_id FROM areas WHERE id = ?) AND lang = ? AND entity_type = 'city'), 'all') as city_slug,
            COALESCE((SELECT slug FROM location_i18n WHERE entity_id = ? AND lang = ? AND entity_type = 'area'), 'all') as area_slug,
            COALESCE(i_l.slug, i_en.slug) as prop_slug
        FROM listings p
        LEFT JOIN listing_i18n i_l ON p.id = i_l.listing_id AND i_l.lang = ?
        LEFT JOIN listing_i18n i_en ON p.id = i_en.listing_id AND i_en.lang = 'en'
        WHERE p.id = ?
    `).bind(property.area_id, l, property.area_id, l, property.area_id, l, l, property.id).all();
    
    if (pathRes && pathRes[0]) {
        const p = pathRes[0] as unknown as {country_slug:string, city_slug:string, area_slug:string, prop_slug:string};
        langPaths[l] = `/properties/${p.country_slug}/${p.city_slug}/${p.area_slug}/${p.prop_slug}`;
    } else {
        langPaths[l] = `/properties/all/all/all/${property.id}`;
    }
}

// Fetch gallery
const { results: gallery } = await db.prepare(`
    SELECT r2_key FROM media WHERE listing_id = ? ORDER BY sort_order ASC
`).bind(property.id).all();

// Fetch amenities
const { results: extras } = await db.prepare(`
    SELECT extra_key FROM listing_extras WHERE listing_id = ?
`).bind(property.id).all();

const canonicalUrl = new URL(Astro.request.url).href;
const seoDescription = property.meta_description || property.description?.substring(0, 160) || '';
const ogImage = property.main_image ? new URL(`/api/media/${property.main_image}`, Astro.request.url).href : null;
---

<PublicLayout 
  title={property.meta_title || property.title} 
  description={seoDescription}
  image={ogImage}
  canonicalUrl={canonicalUrl}
  lang={lang} 
  activePage="properties"
  langPaths={langPaths}
>
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 0.5rem;
      margin: 2rem 0;
      border-radius: 12px;
      overflow: hidden;
      background: #f4f4f5;
      aspect-ratio: 21/9;
    }
    .main-photo { width: 100%; height: 100%; object-fit: cover; }
    .side-photos { display: grid; grid-template-rows: 1fr 1fr; gap: 0.5rem; }
    .side-photo { width: 100%; height: 100%; object-fit: cover; }
    .property-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
    }
    .price-tag {
      font-size: 2.5rem;
      font-weight: 900;
      letter-spacing: -0.05em;
    }
    .details-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 4rem;
      margin-top: 3rem;
    }
    .amenities-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .amenity-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9375rem;
      color: #3f3f46;
    }
    .sidebar-card {
      border: 1px solid #e4e4e7;
      padding: 2rem;
      border-radius: 16px;
      position: sticky;
      top: 6rem;
      background: #fafafa;
    }
    .contact-btn {
      display: block;
      width: 100%;
      padding: 1rem;
      background: #000;
      color: #fff;
      text-align: center;
      border-radius: 12px;
      font-weight: 700;
      text-decoration: none;
      margin-top: 1.5rem;
      transition: transform 0.2s;
    }
    .contact-btn:hover { transform: translateY(-2px); color: #fff; }
    @media (max-width: 768px) {
      .gallery-grid { grid-template-columns: 1fr; aspect-ratio: auto; }
      .side-photos { display: none; }
      .details-grid { grid-template-columns: 1fr; }
    }
  </style>

  <main class="container">
    <div class="gallery-grid">
      <img src={property.main_image ? `/api/media/${property.main_image}?w=1400` : '/placeholder.jpg'} class="main-photo" alt={property.title} fetchpriority="high" decoding="async" />
      <div class="side-photos">
        {gallery.slice(1, 3).map(img => (
          <img src={`/api/media/${img.r2_key}?w=600`} class="side-photo" alt="Gallery item" loading="lazy" decoding="async" />
        ))}
      </div>
    </div>

    <div class="property-header">
      <div>
        <h1 style="font-size: 3rem; font-weight: 900; margin: 0; letter-spacing: -0.05em;">{property.title}</h1>
        <p style="font-size: 1.25rem; color: #71717a; margin-top: 0.5rem;">üìç {property.area_name}</p>
      </div>
      <div class="price-tag">
        {new Intl.NumberFormat(lang === 'bg' ? 'bg-BG' : 'en-US', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(property.price)}
      </div>
    </div>

    <div class="details-grid">
      <div>
        <h2 style="font-weight: 800; margin-bottom: 1.5rem;">{t('property.description') || 'Description'}</h2>
        <div style="white-space: pre-wrap; font-size: 1.125rem; color: #3f3f46;">
          {property.description}
        </div>

        <h2 style="font-weight: 800; margin-top: 4rem; margin-bottom: 1.5rem;">{t('property.amenities') || 'Amenities'}</h2>
        <div class="amenities-list">
          {extras.map(e => (
            <div class="amenity-item">
              <span>‚úÖ</span>
              <span>{e.extra_key}</span>
            </div>
          ))}
        </div>
      </div>

      <aside>
        <div class="sidebar-card">
          <h3 style="margin-top: 0;">{t('property.quick_info') || 'Quick Info'}</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #71717a;">{t('listing.bedrooms')}</span>
              <span style="font-weight: 600;">{property.bedrooms}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #71717a;">Area</span>
              <span style="font-weight: 600;">{property.area_sqm} m¬≤</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #71717a;">Type</span>
              <span style="font-weight: 600; text-transform: capitalize;">{property.property_type}</span>
            </div>
          </div>
          <a href={`/${lang}/contact?id=${property.id}`} class="contact-btn">{t('property.contact_agent') || 'Contact Agent'}</a>
        </div>
      </aside>
    </div>
  </main>
</PublicLayout>
