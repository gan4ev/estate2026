---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getDictionary } from '../../../lib/i18n.js';

const db = Astro.locals.runtime.env.DB;
const adminLang = Astro.cookies.get('admin_lang')?.value || 'en';
const dict = await getDictionary(db, adminLang) || {};
const t = (key: string) => dict[key] || key;

const categories = Object.entries(dict).filter(([k]) => k.startsWith('category.')).map(([k, v]) => ({ value: k.replace('category.', ''), label: v }));
const types = Object.entries(dict).filter(([k]) => k.startsWith('type.')).map(([k, v]) => ({ value: k.replace('type.', ''), label: v }));
const stages = Object.entries(dict).filter(([k]) => k.startsWith('stage.')).map(([k, v]) => ({ value: k.replace('stage.', ''), label: v }));
const extras = Object.entries(dict).filter(([k]) => k.startsWith('extra.')).map(([k, v]) => ({ value: k.replace('extra.', ''), label: v }));

// Fetch hierarchical location data
const { results: countries } = await db.prepare(`SELECT c.id, (SELECT name FROM location_i18n WHERE entity_id = c.id AND lang = ? AND entity_type = 'country') as name FROM countries c`).bind(adminLang).all();
const { results: cities } = await db.prepare(`SELECT c.id, c.country_id, (SELECT name FROM location_i18n WHERE entity_id = c.id AND lang = ? AND entity_type = 'city') as name FROM cities c`).bind(adminLang).all();
const { results: areas } = await db.prepare(`SELECT a.id, a.city_id, (SELECT name FROM location_i18n WHERE entity_id = a.id AND lang = ? AND entity_type = 'area') as name FROM areas a`).bind(adminLang).all();
---

<AdminLayout title={t('admin.create_listing')}>
  <div class="card" style="max-width: 600px;">
    <form id="listingForm" data-cities={JSON.stringify(cities)} data-areas={JSON.stringify(areas)}>
      
      <!-- Language Tabs for Title & Description -->
      <div style="margin-bottom: 1.5rem;">
        <div class="lang-tabs" style="display: flex; gap: 0; margin-bottom: 0; border-bottom: 2px solid #e4e4e7;">
          <button type="button" class="lang-tab active" data-lang="en" style="padding: 0.6rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 700; font-size: 0.9rem; color: #18181b; border-bottom: 2px solid #18181b; margin-bottom: -2px; transition: all 0.2s;">ðŸ‡¬ðŸ‡§ EN</button>
          <button type="button" class="lang-tab" data-lang="bg" style="padding: 0.6rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; font-size: 0.9rem; color: #a1a1aa; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s;">ðŸ‡§ðŸ‡¬ BG</button>
        </div>

        <!-- EN Panel -->
        <div class="lang-panel" data-lang="en" style="padding-top: 1rem;">
          <div class="form-group">
            <label for="title_en">Title (EN) *</label>
            <input type="text" id="title_en" name="title_en" required placeholder="e.g., Luxury 2-Bedroom Apartment in Downtown" />
          </div>
          <div class="form-group">
            <label for="description_en">Description (EN) *</label>
            <textarea id="description_en" name="description_en" required placeholder="Detailed description of the property..."></textarea>
          </div>
        </div>

        <!-- BG Panel -->
        <div class="lang-panel" data-lang="bg" style="padding-top: 1rem; display: none;">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 0.75rem;">
            <button type="button" id="translateBtn" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(99,102,241,0.3);">
              âœ¨ Translate from EN
            </button>
          </div>
          <div class="form-group">
            <label for="title_bg">Title (BG)</label>
            <input type="text" id="title_bg" name="title_bg" placeholder="Ð—Ð°Ð³Ð»Ð°Ð²Ð¸Ðµ Ð½Ð° Ð±ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸..." />
          </div>
          <div class="form-group">
            <label for="description_bg">Description (BG)</label>
            <textarea id="description_bg" name="description_bg" placeholder="ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð½Ð° Ð±ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸..."></textarea>
          </div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 1.5rem;">
        <div class="form-group">
          <label>{t('admin.countries')} *</label>
          <select id="countrySelect">
            <option value="">Select Country</option>
            {countries.map(c => <option value={c.id}>{c.name}</option>)}
          </select>
        </div>
        <div class="form-group">
          <label>{t('admin.cities')} *</label>
          <select id="citySelect" disabled>
            <option value="">Select City</option>
          </select>
        </div>
        <div class="form-group">
          <label>{t('admin.areas')} *</label>
          <select id="area_id" name="area_id" required disabled>
            <option value="">Select Area</option>
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="main_category">{t('admin.main_category')} *</label>
          <select id="main_category" name="main_category" required>
            {categories.map(c => (
              <option value={c.value}>{c.label}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="property_type">{t('admin.property_type')} *</label>
          <select id="property_type" name="property_type" required>
            {types.map(t => (
              <option value={t.value}>{t.label}</option>
            ))}
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="stage">{t('admin.stage')}</label>
          <select id="stage" name="stage">
            <option value="">-- {t('admin.stage')} --</option>
            {stages.map(s => (
              <option value={s.value}>{s.label}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="price">{t('admin.price')} (â‚¬) *</label>
          <input type="number" id="price" name="price" required min="0" step="1" />
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="bedrooms">{t('admin.bedrooms')}</label>
          <input type="number" id="bedrooms" name="bedrooms" min="0" value="0" />
        </div>
        <div class="form-group">
          <label for="bathrooms">{t('admin.bathrooms')}</label>
          <input type="number" id="bathrooms" name="bathrooms" min="0" value="0" />
        </div>
        <div class="form-group">
          <label for="area_sqm">{t('admin.area')} (mÂ²)</label>
          <input type="number" id="area_sqm" name="area_sqm" min="0" value="0" />
        </div>
      </div>

      <div class="form-group" style="margin-top: 1rem;">
          <label>{t('admin.extras')}</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; background: #fafafa; padding: 1rem; border: 1px solid #e4e4e7; border-radius: 6px;">
              {extras.map(e => (
                <label style="font-weight: normal; display: flex; align-items: center; gap: 0.5rem;">
                  <input type="checkbox" name="extras" value={e.value} /> {e.label}
                </label>
              ))}
          </div>
      </div>

      <div style="margin-top: 2rem; display: flex; gap: 1rem; align-items: center;">
        <button type="submit" class="btn" id="submitBtn">{t('admin.save')}</button>
        <a href="/admin/listings" style="color: #71717a; text-decoration: none; font-size: 0.875rem;">{t('admin.cancel')}</a>
        <span id="formStatus" style="font-size: 0.875rem; color: #16a34a; display: none;">Saving...</span>
      </div>

    </form>
  </div>

  <style>
    .lang-tab:hover {
      color: #18181b !important;
    }
    #translateBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99,102,241,0.4);
    }
    #translateBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
  </style>

  <script>
    // Language Tab Switching
    const tabs = document.querySelectorAll('.lang-tab');
    const panels = document.querySelectorAll('.lang-panel');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const lang = tab.dataset.lang;
        tabs.forEach(t => {
          t.classList.remove('active');
          t.style.fontWeight = '500';
          t.style.color = '#a1a1aa';
          t.style.borderBottomColor = 'transparent';
        });
        tab.classList.add('active');
        tab.style.fontWeight = '700';
        tab.style.color = '#18181b';
        tab.style.borderBottomColor = '#18181b';

        panels.forEach(p => {
          p.style.display = p.dataset.lang === lang ? 'block' : 'none';
        });
      });
    });

    // Gemini Translation
    const translateBtn = document.getElementById('translateBtn');
    translateBtn?.addEventListener('click', async () => {
      const titleEn = document.getElementById('title_en')?.value;
      const descEn = document.getElementById('description_en')?.value;

      if (!titleEn && !descEn) {
        alert('Please fill in the English title and description first.');
        return;
      }

      translateBtn.disabled = true;
      translateBtn.textContent = 'â³ Translating...';

      try {
        const resp = await fetch('/api/admin/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceDictionary: { title: titleEn, description: descEn },
            targetLangName: 'Bulgarian'
          })
        });

        const result = await resp.json();

        if (result.success && result.dictionary) {
          document.getElementById('title_bg').value = result.dictionary.title || '';
          document.getElementById('description_bg').value = result.dictionary.description || '';
          translateBtn.textContent = 'âœ… Translated!';
          setTimeout(() => { translateBtn.textContent = 'âœ¨ Translate from EN'; translateBtn.disabled = false; }, 2000);
        } else {
          throw new Error(result.error || 'Translation failed');
        }
      } catch (err) {
        alert('Translation failed: ' + err.message);
        translateBtn.textContent = 'âœ¨ Translate from EN';
        translateBtn.disabled = false;
      }
    });

    // Form & Location Logic
    const form = document.getElementById('listingForm');
    const cities = JSON.parse(form?.dataset.cities || '[]');
    const areas = JSON.parse(form?.dataset.areas || '[]');

    const countrySelect = document.getElementById('countrySelect');
    const citySelect = document.getElementById('citySelect');
    const areaSelect = document.getElementById('area_id');

    countrySelect?.addEventListener('change', (e) => {
      const countryId = e.target.value;
      citySelect.innerHTML = '<option value="">Select City</option>';
      areaSelect.innerHTML = '<option value="">Select Area</option>';
      areaSelect.disabled = true;
      
      if (!countryId) {
        citySelect.disabled = true;
        return;
      }

      const filteredCities = cities.filter(c => c.country_id === countryId);
      filteredCities.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        citySelect.appendChild(opt);
      });
      citySelect.disabled = false;
    });

    citySelect?.addEventListener('change', (e) => {
      const cityId = e.target.value;
      areaSelect.innerHTML = '<option value="">Select Area</option>';
      
      if (!cityId) {
        areaSelect.disabled = true;
        return;
      }

      const filteredAreas = areas.filter(a => a.city_id === cityId);
      filteredAreas.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        areaSelect.appendChild(opt);
      });
      areaSelect.disabled = false;
    });

    const status = document.getElementById('formStatus');
    const btn = document.getElementById('submitBtn');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if(status) { status.style.display = 'inline'; status.textContent = 'Saving...'; status.style.color = '#71717a'; }
      if(btn) btn.disabled = true;

      const formData = new FormData(form as HTMLFormElement);

      try {
        const response = await fetch('/api/admin/listings', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          if(status) { status.style.color = '#16a34a'; status.textContent = 'Saved successfully! Redirecting...'; }
          setTimeout(() => {
            window.location.href = '/admin/listings';
          }, 1000);
        } else {
          throw new Error(result.error || 'Failed to save listing');
        }
      } catch (err) {
        if(status) { status.style.color = '#dc2626'; status.textContent = err.message; }
        if(btn) btn.disabled = false;
      }
    });
  </script>
</AdminLayout>
