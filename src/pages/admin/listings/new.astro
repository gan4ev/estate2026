---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getDictionary } from '../../../lib/i18n.js';

const db = Astro.locals.runtime.env.DB;
const adminLang = Astro.cookies.get('admin_lang')?.value || 'en';
const dict = await getDictionary(db, adminLang) || {};

const categories = Object.entries(dict).filter(([k]) => k.startsWith('category.')).map(([k, v]) => ({ value: k.replace('category.', ''), label: v }));
const types = Object.entries(dict).filter(([k]) => k.startsWith('type.')).map(([k, v]) => ({ value: k.replace('type.', ''), label: v }));
const stages = Object.entries(dict).filter(([k]) => k.startsWith('stage.')).map(([k, v]) => ({ value: k.replace('stage.', ''), label: v }));
const extras = Object.entries(dict).filter(([k]) => k.startsWith('extra.')).map(([k, v]) => ({ value: k.replace('extra.', ''), label: v }));
---

<AdminLayout title="Create New Listing">
  <div class="card" style="max-width: 600px;">
    <form id="listingForm">
      
      <div class="form-group">
        <label for="title">Title (English) *</label>
        <input type="text" id="title" name="title" required placeholder="e.g., Luxury 2-Bedroom Apartment in Downtown" />
      </div>

      <div class="form-group">
        <label for="description">Description *</label>
        <textarea id="description" name="description" required placeholder="Detailed description of the property..."></textarea>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="main_category">Main Category *</label>
          <select id="main_category" name="main_category" required>
            {categories.map(c => (
              <option value={c.value}>{c.label}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="property_type">Property Type *</label>
          <select id="property_type" name="property_type" required>
            {types.map(t => (
              <option value={t.value}>{t.label}</option>
            ))}
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="stage">Construction Stage</label>
          <select id="stage" name="stage">
            <option value="">-- Select Stage --</option>
            {stages.map(s => (
              <option value={s.value}>{s.label}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="price">Price (€) *</label>
          <input type="number" id="price" name="price" required min="0" step="1" />
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="bedrooms">Bedrooms</label>
          <input type="number" id="bedrooms" name="bedrooms" min="0" value="0" />
        </div>
        <div class="form-group">
          <label for="bathrooms">Bathrooms</label>
          <input type="number" id="bathrooms" name="bathrooms" min="0" value="0" />
        </div>
        <div class="form-group">
          <label for="area_sqm">Area (m²)</label>
          <input type="number" id="area_sqm" name="area_sqm" min="0" value="0" />
        </div>
      </div>

      <div class="form-group" style="margin-top: 1rem;">
          <label>Property Extras & Amenities</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; background: #fafafa; padding: 1rem; border: 1px solid #e4e4e7; border-radius: 6px;">
              {extras.map(e => (
                <label style="font-weight: normal; display: flex; align-items: center; gap: 0.5rem;">
                  <input type="checkbox" name="extras" value={e.value} /> {e.label}
                </label>
              ))}
          </div>
          <small style="color: #71717a; display: block; margin-top: 0.5rem;">These are pulled from your Site Translations dictionary.</small>
      </div>

      <div style="margin-top: 2rem; display: flex; gap: 1rem; align-items: center;">
        <button type="submit" class="btn" id="submitBtn">Save Listing</button>
        <a href="/admin/listings" style="color: #71717a; text-decoration: none; font-size: 0.875rem;">Cancel</a>
        <span id="formStatus" style="font-size: 0.875rem; color: #16a34a; display: none;">Saving...</span>
      </div>

    </form>
  </div>

  <script>
    const form = document.getElementById('listingForm') as HTMLFormElement;
    const status = document.getElementById('formStatus');
    const btn = document.getElementById('submitBtn') as HTMLButtonElement;

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if(status) { status.style.display = 'inline'; status.textContent = 'Saving...'; status.style.color = '#71717a'; }
      if(btn) btn.disabled = true;

      const formData = new FormData(form);

      try {
        const response = await fetch('/api/admin/listings', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          if(status) { status.style.color = '#16a34a'; status.textContent = 'Saved successfully! Redirecting...'; }
          setTimeout(() => {
            window.location.href = '/admin/listings';
          }, 1000);
        } else {
          throw new Error(result.error || 'Failed to save listing');
        }
      } catch (err: any) {
        if(status) { status.style.color = '#dc2626'; status.textContent = err.message; }
        if(btn) btn.disabled = false;
      }
    });
  </script>
</AdminLayout>
