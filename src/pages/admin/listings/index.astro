---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getDictionary } from '../../../lib/i18n.js';

// We can fetch data directly in the Astro component using the D1 binding!
const db = Astro.locals.runtime.env.DB;
const adminLang = Astro.cookies.get('admin_lang')?.value || 'en';
const dict = await getDictionary(db, adminLang) || {};
const t = (key: string) => dict[key] || key;

const { results: listings } = await db.prepare(`
  SELECT l.*, i.title,
  (SELECT name FROM location_i18n WHERE entity_id = l.area_id AND lang = ? AND entity_type = 'area') as area_name
  FROM listings l
  LEFT JOIN listing_i18n i ON l.id = i.listing_id AND i.lang = ?
  ORDER BY l.created_at DESC
`).bind(adminLang, adminLang).all();
---

<AdminLayout title={t('admin.manage_properties')}>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>{t('admin.all_listings')} ({listings.length})</h2>
    <a href="/admin/listings/new" class="btn">+ {t('admin.create_listing')}</a>
  </div>

  <div class="card" style="padding: 0;">
    <table style="width: 100%; border-collapse: collapse; text-align: left;">
      <thead>
        <tr style="border-bottom: 1px solid #e4e4e7; background: #f8f8f8;">
          <th style="padding: 1rem;">{t('admin.title')}</th>
          <th style="padding: 1rem;">{t('admin.main_category')}</th>
          <th style="padding: 1rem;">{t('admin.property_type')}</th>
          <th style="padding: 1rem;">{t('admin.area')}</th>
          <th style="padding: 1rem;">{t('admin.price')}</th>
          <th style="padding: 1rem;">{t('admin.status')}</th>
          <th style="padding: 1rem;">{t('admin.actions')}</th>
        </tr>
      </thead>
      <tbody>
        {listings.length === 0 ? (
          <tr>
            <td colspan="6" style="padding: 2rem; text-align: center; color: #71717a;">
              No properties found. Create your first listing to get started!
            </td>
          </tr>
        ) : (
          listings.map((l: any) => (
            <tr style="border-bottom: 1px solid #e4e4e7;">
              <td style="padding: 1rem; font-weight: 500;">{l.title || 'Untitled'}</td>
              <td style="padding: 1rem; text-transform: capitalize;">{dict[`category.${l.main_category}`] || l.main_category?.replace('_', ' ')}</td>
              <td style="padding: 1rem; text-transform: capitalize;">{dict[`type.${l.property_type}`] || l.property_type}</td>
              <td style="padding: 1rem;">{l.area_name || <span style="color: #a1a1aa; font-size: 0.8rem;">Not specified</span>}</td>
              <td style="padding: 1rem;">â‚¬{l.price?.toLocaleString()}</td>
              <td style="padding: 1rem;">
                <span style="background: #e4e4e7; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                  {l.status}
                </span>
              </td>
              <td style="padding: 1rem;">
                <div style="display: flex; gap: 0.5rem;">
                  <a href={`/admin/listings/${l.id}`} class="btn" style="background: #2563eb; color: white;">{t('admin.update')}</a>
                  <button onclick={`deleteListing('${l.id}')`} class="btn" style="background: #dc2626; color: white;">{t('admin.delete')}</button>
                </div>
              </td>
            </tr>
          ))
        )}
      </tbody>
    </table>
  </div>

  <script is:inline>
    async function deleteListing(id) {
      if (!confirm('Are you sure you want to delete this property listing? This action cannot be undone.')) return;
      
      try {
        const response = await fetch(`/api/admin/listings/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          window.location.reload();
        } else {
          const result = await response.json();
          alert(result.error || 'Failed to delete listing');
        }
      } catch (err) {
        alert(err.message);
      }
    }
  </script>
</AdminLayout>
