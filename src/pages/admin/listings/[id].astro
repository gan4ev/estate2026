---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getDictionary } from '../../../lib/i18n.js';

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;
const adminLang = Astro.cookies.get('admin_lang')?.value || 'en';
const dict = await getDictionary(db, adminLang) || {};
const t = (key: string) => dict[key] || key;

const categories = Object.entries(dict).filter(([k]) => k.startsWith('category.')).map(([k, v]) => ({ value: k.replace('category.', ''), label: v }));
const types = Object.entries(dict).filter(([k]) => k.startsWith('type.')).map(([k, v]) => ({ value: k.replace('type.', ''), label: v }));
const stages = Object.entries(dict).filter(([k]) => k.startsWith('stage.')).map(([k, v]) => ({ value: k.replace('stage.', ''), label: v }));
const extras = Object.entries(dict).filter(([k]) => k.startsWith('extra.')).map(([k, v]) => ({ value: k.replace('extra.', ''), label: v }));

// Fetch existing listing data with location hierarchy
const { results } = await db.prepare(`
    SELECT l.*, i.title, i.description,
           a.city_id, ci.country_id
    FROM listings l
    LEFT JOIN listing_i18n i ON l.id = i.listing_id AND i.lang = 'en'
    LEFT JOIN areas a ON l.area_id = a.id
    LEFT JOIN cities ci ON a.city_id = ci.id
    WHERE l.id = ?
`).bind(id).all();

if (!results || results.length === 0) {
    return Astro.redirect('/admin/listings');
}

const listing = results[0];

// Fetch hierarchical location data for dropdowns
const { results: countries } = await db.prepare(`SELECT c.id, (SELECT name FROM location_i18n WHERE entity_id = c.id AND lang = ? AND entity_type = 'country') as name FROM countries c`).bind(adminLang).all();
const { results: cities } = await db.prepare(`SELECT c.id, c.country_id, (SELECT name FROM location_i18n WHERE entity_id = c.id AND lang = ? AND entity_type = 'city') as name FROM cities c`).bind(adminLang).all();
const { results: areas } = await db.prepare(`SELECT a.id, a.city_id, (SELECT name FROM location_i18n WHERE entity_id = a.id AND lang = ? AND entity_type = 'area') as name FROM areas a`).bind(adminLang).all();

// Fetch existing extras
const { results: extrasResults } = await db.prepare(`
    SELECT extra_key FROM listing_extras WHERE listing_id = ?
`).bind(id).all();
const activeExtras = extrasResults.map((r: any) => r.extra_key);

// Fetch existing media
const { results: mediaResults } = await db.prepare(`
    SELECT * FROM media WHERE listing_id = ? ORDER BY sort_order ASC
`).bind(id).all();
const media = mediaResults || [];
---

<AdminLayout title={t('admin.edit_listing')}>
  <div class="card" style="max-width: 600px;">
    <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: start;">
        <div>
            <a href="/admin/listings" style="color: #71717a; text-decoration: none; font-size: 0.875rem;">&larr; {t('admin.all_listings')}</a>
            <h2 style="margin: 0.5rem 0 0 0;">{t('admin.edit_listing')}</h2>
        </div>
        <span style="background: #e4e4e7; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase;">
            ID: {id?.slice(0,8)}...
        </span>
    </div>

    <form id="editListingForm" data-listing-id={id} data-cities={JSON.stringify(cities)} data-areas={JSON.stringify(areas)}>
      
      <div class="form-group">
        <label for="title">{t('admin.title')} ({t('en')}) *</label>
        <input type="text" id="title" name="title" required value={listing.title} />
      </div>

      <div class="form-group">
        <label for="description">{t('admin.description')} *</label>
        <textarea id="description" name="description" required>{listing.description}</textarea>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 1.5rem;">
        <div class="form-group">
          <label>{t('admin.countries')} *</label>
          <select id="countrySelect">
            <option value="">Select Country</option>
            {countries.map(c => <option value={c.id} selected={c.id === listing.country_id}>{c.name}</option>)}
          </select>
        </div>
        <div class="form-group">
          <label>{t('admin.cities')} *</label>
          <select id="citySelect" disabled={!listing.city_id}>
            <option value="">Select City</option>
            {cities.filter(ci => ci.country_id === listing.country_id).map(ci => (
              <option value={ci.id} selected={ci.id === listing.city_id}>{ci.name}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label>{t('admin.areas')} *</label>
          <select id="area_id" name="area_id" required disabled={!listing.area_id}>
            <option value="">Select Area</option>
            {areas.filter(a => a.city_id === listing.city_id).map(a => (
              <option value={a.id} selected={a.id === listing.area_id}>{a.name}</option>
            ))}
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="main_category">{t('admin.main_category')} *</label>
          <select id="main_category" name="main_category" required>
            {categories.map(c => (
              <option value={c.value} selected={listing.main_category === c.value}>{c.label}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="property_type">{t('admin.property_type')} *</label>
          <select id="property_type" name="property_type" required>
            {types.map(t => (
              <option value={t.value} selected={listing.property_type === t.value}>{t.label}</option>
            ))}
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="stage">{t('admin.stage')}</label>
          <select id="stage" name="stage">
            <option value="">-- {t('admin.stage')} --</option>
            {stages.map(s => (
              <option value={s.value} selected={listing.stage === s.value}>{s.label}</option>
            ))}
          </select>
        </div>
        <div class="form-group">
          <label for="price">{t('admin.price')} (€) *</label>
          <input type="number" id="price" name="price" required min="0" step="1" value={listing.price} />
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="bedrooms">{t('admin.bedrooms')}</label>
          <input type="number" id="bedrooms" name="bedrooms" min="0" value={listing.bedrooms} />
        </div>
        <div class="form-group">
          <label for="bathrooms">{t('admin.bathrooms')}</label>
          <input type="number" id="bathrooms" name="bathrooms" min="0" value={listing.bathrooms} />
        </div>
        <div class="form-group">
          <label for="area_sqm">{t('admin.area')} (m²)</label>
          <input type="number" id="area_sqm" name="area_sqm" min="0" value={listing.area_sqm} />
        </div>
      </div>

      <div class="form-group">
        <label for="status">{t('admin.status')}</label>
        <select id="status" name="status">
          <option value="draft" selected={listing.status === 'draft'}>Draft</option>
          <option value="published" selected={listing.status === 'published'}>Published</option>
          <option value="archived" selected={listing.status === 'archived'}>Archived</option>
        </select>
      </div>

      <div class="form-group" style="margin-top: 1rem;">
          <label>{t('admin.extras')}</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; background: #fafafa; padding: 1rem; border: 1px solid #e4e4e7; border-radius: 6px;">
              {extras.map(e => (
                <label style="font-weight: normal; display: flex; align-items: center; gap: 0.5rem;">
                  <input type="checkbox" name="extras" value={e.value} checked={activeExtras.includes(e.value)} /> {e.label}
                </label>
              ))}
          </div>
      </div>

      <div style="margin-top: 2rem; border-top: 1px solid #e4e4e7; padding-top: 2rem;">
        <h3>{t('admin.media')}</h3>
        <p style="color: #71717a; font-size: 0.875rem;">Upload and manage images for this property. Drag and drop doesn't work yet, but you can sort using the arrows.</p>
        
        <div id="mediaGallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
          {media.map((m: any) => (
            <div class="media-item" draggable="true" data-id={m.id} style="position: relative; aspect-ratio: 1; border: 1px solid #e4e4e7; border-radius: 8px; overflow: hidden; background: #f8f8f8; cursor: move; transition: transform 0.2s, box-shadow 0.2s;">
              <img src={`/api/media/${m.r2_key}`} style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" alt="" />
              <div class="media-actions" style="position: absolute; top: 0; right: 0; padding: 4px; display: flex; justify-content: flex-end;">
                <button type="button" class="delete-media" data-id={m.id} style="background: rgba(255,107,107,0.8); border: none; color: white; cursor: pointer; border-radius: 4px; padding: 2px 6px; font-weight: bold;">&times;</button>
              </div>
              {m.is_primary ? <span style="position: absolute; top: 4px; left: 4px; background: #16a34a; color: white; padding: 2px 6px; font-size: 0.7rem; border-radius: 4px;">Primary</span> : null}
            </div>
          ))}
        </div>

        <style>
          .media-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
          }
          .media-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
          }
        </style>

        <div style="margin-top: 1.5rem; border: 2px dashed #e4e4e7; padding: 2rem; text-align: center; border-radius: 8px;">
          <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" />
          <button type="button" class="btn" onclick="document.getElementById('fileInput').click()">{t('admin.add_images')}</button>
          <p style="margin-top: 0.5rem; color: #71717a; font-size: 0.875rem;">JPG, PNG or WEBP up to 5MB</p>
        </div>
      </div>

      <div style="margin-top: 2rem; display: flex; gap: 1rem; align-items: center;">
        <button type="submit" class="btn" id="updateBtn">{t('admin.update')}</button>
        <a href="/admin/listings" style="color: #71717a; text-decoration: none; font-size: 0.875rem;">{t('admin.cancel')}</a>
        <span id="formStatus" style="font-size: 0.875rem; color: #16a34a; display: none;">{t('admin.update')}...</span>
      </div>

    </form>
  </div>

  <script>
    const form = document.getElementById('editListingForm');
    const listingId = form?.dataset.listingId;
    const cities = JSON.parse(form?.dataset.cities || '[]');
    const areas = JSON.parse(form?.dataset.areas || '[]');

    const countrySelect = document.getElementById('countrySelect');
    const citySelect = document.getElementById('citySelect');
    const areaSelect = document.getElementById('area_id');

    countrySelect?.addEventListener('change', (e) => {
      const countryId = e.target.value;
      citySelect.innerHTML = '<option value="">Select City</option>';
      areaSelect.innerHTML = '<option value="">Select Area</option>';
      areaSelect.disabled = true;
      
      if (!countryId) {
        citySelect.disabled = true;
        return;
      }

      const filteredCities = cities.filter(c => c.country_id === countryId);
      filteredCities.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        citySelect.appendChild(opt);
      });
      citySelect.disabled = false;
    });

    citySelect?.addEventListener('change', (e) => {
      const cityId = e.target.value;
      areaSelect.innerHTML = '<option value="">Select Area</option>';
      
      if (!cityId) {
        areaSelect.disabled = true;
        return;
      }

      const filteredAreas = areas.filter(a => a.city_id === cityId);
      filteredAreas.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        areaSelect.appendChild(opt);
      });
      areaSelect.disabled = false;
    });

    const status = document.getElementById('formStatus');
    const btn = document.getElementById('updateBtn') ;

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if(status) { status.style.display = 'inline'; status.textContent = 'Updating...'; status.style.color = '#71717a'; }
      if(btn) btn.disabled = true;

      const formData = new FormData(form);

      try {
        const response = await fetch(`/api/admin/listings/${listingId}`, {
          method: 'PUT',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          if(status) { status.style.color = '#16a34a'; status.textContent = 'Updated successfully!'; }
          setTimeout(() => {
            window.location.href = '/admin/listings';
          }, 1000);
        } else {
          throw new Error(result.error || 'Failed to update listing');
        }
      } catch (err) {
        if(status) { status.style.color = '#dc2626'; status.textContent = err.message; }
        if(btn) btn.disabled = false;
      }
    });

    // Media Logic
    const fileInput = document.getElementById('fileInput');
    const gallery = document.getElementById('mediaGallery');

    fileInput?.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files?.length) return;

        const formData = new FormData();
        formData.append('listing_id', listingId);
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        try {
            const resp = await fetch('/api/admin/media/upload', {
                method: 'POST',
                body: formData
            });
            if (resp.ok) window.location.reload();
            else console.error('Upload failed');
        } catch (err) {
            console.error(err);
        }
    });

    let draggedItem = null;

    gallery?.addEventListener('dragstart', (e) => {
        draggedItem = e.target.closest('.media-item');
        if (draggedItem) {
            draggedItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
    });

    gallery?.addEventListener('dragover', (e) => {
        e.preventDefault();
        const target = e.target.closest('.media-item');
        if (target && target !== draggedItem) {
            const bounding = target.getBoundingClientRect();
            const offset = (e.clientX - bounding.left) / bounding.width;
            if (offset > 0.5) {
                target.after(draggedItem);
            } else {
                target.before(draggedItem);
            }
        }
    });

    gallery?.addEventListener('drop', (e) => {
        e.preventDefault();
        saveSortOrder();
    });

    gallery?.addEventListener('dragend', (e) => {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
        }
        draggedItem = null;
    });

    gallery?.addEventListener('click', async (e) => {
        const target = e.target;
        const item = target.closest('.media-item');
        if (!item) return;
        const id = item.dataset.id;

        if (target.classList.contains('delete-media')) {
            if (!confirm('Are you sure?')) return;
            try {
                const resp = await fetch(`/api/admin/media/${id}`, { method: 'DELETE' });
                if (resp.ok) item.remove();
            } catch (err) { console.error(err); }
        }
    });

    async function saveSortOrder() {
        if (!gallery) return;
        const ids = Array.from(gallery.querySelectorAll('.media-item')).map(el => el.dataset.id);
        try {
            await fetch('/api/admin/media/sort', {
                method: 'PATCH',
                body: JSON.stringify({ mediaIds: ids }),
                headers: { 'Content-Type': 'application/json' }
            });
        } catch (err) { console.error('Sort failed', err); }
    }
  </script>
</AdminLayout>
