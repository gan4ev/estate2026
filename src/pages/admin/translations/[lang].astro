---
import AdminLayout from '../../../layouts/AdminLayout.astro';
const db = Astro.locals.runtime?.env?.DB;
const { lang } = Astro.params;

let dictionary: Record<string, string> = {};
let englishDict: Record<string, string> = {};

if (db) {
    // Get target lang
    const { results } = await db.prepare('SELECT dictionary FROM site_translations WHERE lang = ?').bind(lang).all();
    if (results && results.length > 0) dictionary = JSON.parse(results[0].dictionary as string);
    
    // Get english base for guaranteed key comparison
    const { results: enResults } = await db.prepare('SELECT dictionary FROM site_translations WHERE lang = ?').bind('en').all();
    if (enResults && enResults.length > 0) englishDict = JSON.parse(enResults[0].dictionary as string);
}
---
<AdminLayout title={`Editing ${lang?.toUpperCase()} Translations`}>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <div>
          <a href="/admin/translations" style="display: inline-block; margin-bottom: 0.5rem; text-decoration: none; color: #71717a;">&larr; Back to Languages</a>
          <h2 style="margin: 0;">Language Dictionary: {lang?.toUpperCase()}</h2>
      </div>
      
      {lang !== 'en' && (
      <button id="aiTranslateBtn" style="padding: 0.75rem 1.25rem; background: linear-gradient(45deg, #8b5cf6, #3b82f6); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.25);">
          ✨ Map to Gemini AI Translator
      </button>
      )}
  </div>

  <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
     <form id="dictForm">
         {Object.entries(englishDict).map(([key, enValue]) => (
             <div style="margin-bottom: 1.5rem;">
                 <label style="display: block; font-weight: 600; color: #18181b; margin-bottom: 0.25rem;">{key}</label>
                 <div style="font-size: 0.875rem; color: #71717a; margin-bottom: 0.5rem;">Baseline EN: <span style="font-style: italic;">"{enValue}"</span></div>
                 <input type="text" name={key} value={dictionary[key] || ''} style="width: 100%; padding: 0.75rem; border: 1px solid #d4d4d8; border-radius: 6px; box-sizing: border-box; font-size: 1rem;" />
             </div>
         ))}
         
         <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #eaeaea; display: flex; justify-content: flex-end;">
             <button type="submit" style="padding: 0.75rem 2rem; background: #18181b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;">Save Network Dictionary</button>
         </div>
     </form>
  </div>

  <script define:vars={{ currentLang: lang, baseDictionary: englishDict }}>
      document.getElementById('dictForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector('button[type="submit"]');
          btn.innerText = "Saving edge bundle...";
          
          const formData = new FormData(e.target);
          const newDict = {};
          formData.forEach((value, key) => { newDict[key] = value });
          
          try {
              const res = await fetch('/api/admin/translations', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ lang: currentLang, dictionary: newDict })
              });
              if (res.ok) alert("Translations saved successfully to Edge Database!");
              else alert("Failed to save properties");
          } catch (e) {
              alert("Error saving: " + e.message);
          } finally {
              btn.innerText = "Save Network Dictionary";
          }
      });

      document.getElementById('aiTranslateBtn')?.addEventListener('click', async (e) => {
          const btn = e.target;
          const originalText = btn.innerText;
          btn.innerText = "✨ Magic Translating... Please wait...";
          btn.disabled = true;
          btn.style.opacity = '0.7';
          
          try {
              // We pass the english fallback definitions to the endpoint, parsing it by target lang
              const res = await fetch('/api/admin/gemini', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                      sourceDictionary: baseDictionary, 
                      targetLangName: currentLang
                  })
              });
              
              const data = await res.json();
              if (data.success && data.dictionary) {
                  // Re-populate the input fields with the AI's translated JSON payload safely
                  for (const [key, translatedValue] of Object.entries(data.dictionary)) {
                      const input = document.querySelector(`input[name="${key}"]`);
                      if (input) {
                          input.value = translatedValue;
                          // Optional styling hit
                          input.style.borderColor = '#10b981';
                      }
                  }
                  alert("Gemini Translation complete! Review the values and click Save.");
              } else {
                  alert(data.error || "AI translation failed.");
              }
          } catch (err) {
              alert("Error executing AI request: " + err.message);
          } finally {
              btn.innerText = originalText;
              btn.disabled = false;
              btn.style.opacity = '1';
          }
      });
  </script>
</AdminLayout>
