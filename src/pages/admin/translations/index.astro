---
import AdminLayout from '../../../layouts/AdminLayout.astro';
const db = Astro.locals.runtime?.env?.DB;

let translations = [];
if (db) {
    const { results } = await db.prepare('SELECT lang, updated_at FROM site_translations ORDER BY lang').all();
    translations = results || [];
}
---
<AdminLayout title="Translations Manager">
  <h2>Translations Dashboard</h2>
  <div style="display: flex; gap: 1rem; align-items: start;">
    <div style="flex: 1;">
       <table style="width: 100%; text-align: left; border-collapse: collapse;">
         <thead>
           <tr style="border-bottom: 2px solid #eaeaea;">
             <th style="padding: 0.5rem 0;">Language Code</th>
             <th style="padding: 0.5rem 0;">Last Updated</th>
             <th style="padding: 0.5rem 0;">Actions</th>
           </tr>
         </thead>
         <tbody>
           {translations.map((t: any) => (
             <tr style="border-bottom: 1px solid #eaeaea;">
               <td style="padding: 0.75rem 0;"><strong>{t.lang.toUpperCase()}</strong></td>
               <td style="padding: 0.75rem 0;">{new Date(t.updated_at).toLocaleString()}</td>
               <td style="padding: 0.75rem 0;">
                 <a href={`/admin/translations/${t.lang}`} style="margin-right: 1rem; color: #2563eb;">Edit Dictionary</a>
                 {t.lang !== 'en' && (
                     <button onclick={`deleteLang('${t.lang}')`} style="background: none; border: none; color: #dc2626; cursor: pointer;">Delete</button>
                 )}
               </td>
             </tr>
           ))}
           {translations.length === 0 && (
             <tr><td colspan="3" style="padding: 1rem 0; color: #71717a;">No dictionaries loaded in DB. Did you run the SQL seeds?</td></tr>
           )}
         </tbody>
       </table>
    </div>
    
    <div style="width: 300px; padding: 1.5rem; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <h3>Add New Language</h3>
      <form id="addLangForm">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Language Code</label>
          <input type="text" id="newLang" required placeholder="e.g. 'fr' or 'de'" style="width: 100%; padding: 0.5rem; border: 1px solid #d4d4d8; border-radius: 4px; box-sizing: border-box;" />
        </div>
        <button type="submit" style="width: 100%; padding: 0.5rem; background: #18181b; color: white; border: none; border-radius: 4px; cursor: pointer;">Initialize Language</button>
      </form>
    </div>
  </div>

  <script is:inline>
    document.getElementById('addLangForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const langCode = document.getElementById('newLang').value.toLowerCase().trim();
        
        try {
            // First we fetch the base English dictionary to duplicate it for the new language
            const res = await fetch('/api/admin/translations?lang=en');
            const data = await res.json();
            
            if (!data.dictionary) return alert("Failed to load English baseline.");
            
            const createRes = await fetch('/api/admin/translations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lang: langCode, dictionary: data.dictionary })
            });
            
            if (createRes.ok) {
                window.location.href = `/admin/translations/${langCode}`;
            } else {
                const err = await createRes.json();
                alert(err.error || 'Failed to create language');
            }
        } catch (e) {
            alert(e.message);
        }
    });

    window.deleteLang = async function(lang) {
        if (!confirm(`Are you sure you want to completely delete the ${lang.toUpperCase()} translations?`)) return;
        
        try {
            const res = await fetch(`/api/admin/translations?lang=${lang}`, { method: 'DELETE' });
            if (res.ok) {
                window.location.reload();
            } else {
                const err = await res.json();
                alert(err.error || 'Failed to delete');
            }
        } catch (e) {
            alert(e.message);
        }
    }
  </script>
</AdminLayout>
